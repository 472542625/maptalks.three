!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,function(t,U,R){"use strict";function r(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function E(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}define(["exports"],function(t){var M=n,e=n;function n(t,e,n){n=n||2;var r,i,o,a,s,h,u,l=e&&e.length,c=l?e[0]*n:t.length,f=p(t,0,c,n,!0),v=[];if(!f||f.next===f.prev)return v;if(l&&(f=function(t,e,n,r){var i,o,a,s,h,u=[];for(i=0,o=e.length;i<o;i++)a=e[i]*r,s=i<o-1?e[i+1]*r:t.length,(h=p(t,a,s,r,!1))===h.next&&(h.steiner=!0),u.push(_(h));for(u.sort(y),i=0;i<u.length;i++)m(u[i],n),n=g(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var d=n;d<c;d+=n)(s=t[d])<r&&(r=s),(h=t[d+1])<i&&(i=h),o<s&&(o=s),a<h&&(a=h);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return x(f,v,n,r,i,u),v}function p(t,e,n,r,i){var o,a;if(i===0<S(t,e,n,r))for(o=e;o<n;o+=r)a=s(o,t[o],t[o+1],a);else for(o=n-r;e<=o;o-=r)a=s(o,t[o],t[o+1],a);return a&&d(a,a.next)&&(T(a),a=a.next),a}function g(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!d(r,r.next)&&0!==j(r.prev,r,r.next))r=r.next;else{if(T(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function x(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;for(;null===i.z&&(i.z=b(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,h,u=1;do{for(n=t,o=t=null,a=0;n;){for(a++,r=n,e=s=0;e<u&&(s++,r=r.nextZ);e++);for(h=u;0<s||0<h&&r;)0!==s&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,h--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(t,r,i,o);for(var s,h,u=t;t.prev!==t.next;)if(s=t.prev,h=t.next,o?c(t,r,i,o):l(t))e.push(s.i/n),e.push(t.i/n),e.push(h.i/n),T(t),t=h.next,u=h.next;else if((t=h)===u){a?1===a?x(t=f(g(t),e,n),e,n,r,i,o,2):2===a&&v(t,e,n,r,i,o):x(g(t),e,n,r,i,o,1);break}}}function l(t){var e=t.prev,n=t,r=t.next;if(0<=j(e,n,r))return!1;for(var i=t.next.next;i!==t.prev;){if(w(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=j(i.prev,i,i.next))return!1;i=i.next}return!0}function c(t,e,n,r){var i=t.prev,o=t,a=t.next;if(0<=j(i,o,a))return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,h=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,c=b(s,h,e,n,r),f=b(u,l,e,n,r),v=t.prevZ,d=t.nextZ;v&&v.z>=c&&d&&d.z<=f;){if(v!==t.prev&&v!==t.next&&w(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=j(v.prev,v,v.next))return!1;if(v=v.prevZ,d!==t.prev&&d!==t.next&&w(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=j(d.prev,d,d.next))return!1;d=d.nextZ}for(;v&&v.z>=c;){if(v!==t.prev&&v!==t.next&&w(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=j(v.prev,v,v.next))return!1;v=v.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&w(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=j(d.prev,d,d.next))return!1;d=d.nextZ}return!0}function f(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!d(i,o)&&O(i,r,r.next,o)&&A(i,o)&&A(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),T(r),T(r.next),r=t=o),r=r.next}while(r!==t);return g(r)}function v(t,e,n,r,i,o){var a,s,h=t;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&(s=u,(a=h).next.i!==s.i&&a.prev.i!==s.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&O(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(a,s)&&(A(a,s)&&A(s,a)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==t;);return r}(a,s)&&(j(a.prev,a,s.prev)||j(a,s.prev,s))||d(a,s)&&0<j(a.prev,a,a.next)&&0<j(s.prev,s,s.next)))){var l=C(h,u);return h=g(h,h.next),l=g(l,l.next),x(h,e,n,r,i,o),void x(l,e,n,r,i,o)}u=u.next}h=h.next}while(h!==t)}function y(t,e){return t.x-e.x}function m(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var h,u=n,l=n.x,c=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=l&&i!==r.x&&w(o<c?i:a,o,l,c,o<c?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),A(r,t)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&(d=r,j((v=n).prev,v,d.prev)<0&&j(d.next,v,v.next)<0)))&&(n=r,f=h)),r=r.next,r!==u;);var v,d;return n}(t,e)){var n=C(e,t);g(n,n.next)}}function b(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function _(t){for(var e=t,n=t;(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),(e=e.next)!==t;);return n}function w(t,e,n,r,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(r-s)-(n-a)*(e-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function j(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function d(t,e){return t.x===e.x&&t.y===e.y}function O(t,e,n,r){var i=u(j(t,e,n)),o=u(j(t,e,r)),a=u(j(n,r,t)),s=u(j(n,r,e));return i!==o&&a!==s||(!(0!==i||!h(t,n,e))||(!(0!==o||!h(t,r,e))||(!(0!==a||!h(n,t,r))||!(0!==s||!h(n,e,r)))))}function h(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function u(t){return 0<t?1:t<0?-1:0}function A(t,e){return j(t.prev,t,t.next)<0?0<=j(t,e,t.next)&&0<=j(t,t.prev,e):j(t,e,t.prev)<0||j(t,t.next,e)<0}function C(t,e){var n=new a(t.i,t.x,t.y),r=new a(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function s(t,e,n,r){var i=new a(t,e,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function T(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function a(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function S(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function B(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);1<s?(r=n[0],i=n[1]):0<s&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function i(t,e){var n=t.length-1,r=[t[0]];return function t(e,n,r,i,o){for(var a,s=i,h=n+1;h<r;h++){var u=B(e[h],e[n],e[r]);s<u&&(a=h,s=u)}i<s&&(1<a-n&&t(e,n,a,i,o),o.push(e[a]),1<r-a&&t(e,a,r,i,o))}(t,0,n,e,r),r.push(t[n]),r}function o(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=i(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],h=[s],u=1,l=t.length;u<l;u++)n=t[u],i=s,o=(r=n)[0]-i[0],a=r[1]-i[1],e<o*o+a*a&&(h.push(n),s=n);return s!==n&&h.push(n),h}(t,r),r)}function k(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function V(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function z(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}n.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(S(t,0,o,n));if(i)for(var s=0,h=e.length;s<h;s++){var u=e[s]*n,l=s<h-1?e[s+1]*n:t.length;a-=Math.abs(S(t,u,l,n))}var c=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,v=r[s+1]*n,d=r[s+2]*n;c+=Math.abs((t[f]-t[d])*(t[v+1]-t[f+1])-(t[f]-t[v])*(t[d+1]-t[f+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);0<i&&(r+=t[i-1].length,n.holes.push(r))}return n},M.default=e;var I=[];function lt(t,e,n,r){var i,o,a,s,h,u,l,c,f,v,d,p=(o=n,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(p)*r;return V(I,n,e,-p),h=(s=a=I)[0],u=s[1],l=s[2],c=Math.sqrt(h*h+u*u+l*l),a[0]=h/c,a[1]=u/c,a[2]=l/c,f=t,v=e,d=Math.cos(g),f[0]=v[0]*d,f[1]=v[1]*d,f[2]=v[2]*d,V(t,t,I,Math.sin(g)),t}function P(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],h=t[o],u=t[o+1];i=o,o+=2,r+=a*u-h*s}return r}var L=[],E=[],Z=[];function U(t,e,n,r,i,o,a,s){var h,u,l,c,f,v=null!=a,d=i,p=null;v&&(p=new Uint32Array(r-n));for(var g=n;g<r;g++){var x=g===r-1?n:g+1,y=g===n?r-1:g-1,m=t[2*y],b=t[2*y+1],_=t[2*g],M=t[2*g+1],w=t[2*x],j=t[2*x+1];if(L[0]=_-m,L[1]=M-b,E[0]=w-_,E[1]=j-M,k(L,L),k(E,E),v&&(p[g]=d),s||g!==n)if(s||g!==r-1){c=E,f=L,(l=Z)[0]=c[0]+f[0],l[1]=c[1]+f[1];var O=Z[1];Z[1]=-Z[0],Z[0]=O,k(Z,Z);var A=(u=E,(h=Z)[0]*u[0]+h[1]*u[1]),C=Math.sqrt(1-A*A),T=o*Math.min(10,1/C);if(v&&a<1/C&&o*A<0){var S=_+Z[0]*o,B=M+Z[1]*o,V=Math.acos(C)/2,z=Math.tan(V)*Math.abs(o);e[2*d]=S+Z[1]*z,e[2*d+1]=B-Z[0]*z,e[2*++d]=S-Z[1]*z,e[2*d+1]=B+Z[0]*z,d++}else e[2*d]=_+Z[0]*T,e[2*d+1]=M+Z[1]*T,d++}else Z[0]=L[1],Z[1]=-L[0],k(Z,Z),e[2*d]=_+Z[0]*o,e[2*d+1]=M+Z[1]*o,d++;else Z[0]=E[1],Z[1]=-E[0],k(Z,Z),e[2*d]=_+Z[0]*o,e[2*d+1]=M+Z[1]*o,d++}return p}function R(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(U(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];U(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function F(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,h=t[a];t[a]=t[s],t[s]=h}return t}function G(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;0<P(t,r,i)&&F(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)P(t,r=e[o-1],i=e[o]||n)<0&&F(t,2,r,i)}var ct=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function W(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,h=e.depth,u=e.rect,l=r-n,c=o.smoothSide?1:2,f=l*c,v=o.smoothBevel?1:2,d=Math.min(h/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,x=Math.max(u.width,u.height);if(0<d)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],M=0,w=new Float32Array(l),j=0;j<2;j++)for(var O=0===j?h-d:d,A=0;A<=p*v;A++){for(var C=0,T=void 0,S=void 0,B=0;B<l;B++){for(var V=0;V<c;V++){var z=2*((B+V)%l+n);m[0]=a[z]-s[z],m[1]=a[z+1]-s[z+1],m[2]=0;var k=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=k,m[1]/=k;var I=(Math.floor(A/v)+A%v)/p;0===j?lt(_,y,m,I):lt(_,m,b,I);var P=0===j?I:1-I,L=d*Math.sin(P*Math.PI/2),E=k*Math.cos(P*Math.PI/2),Z=d*k/Math.sqrt(L*L+E*E),U=_[0]*Z+s[z],R=_[1]*Z+s[z+1],F=_[2]*Z+O;if(t.position[3*i.vertex]=U,t.position[3*i.vertex+1]=R,t.position[3*i.vertex+2]=F,(0<B||0<V)&&(C+=Math.sqrt((T-U)*(T-U)+(S-R)*(S-R))),0<A||0<j){var G=3*(i.vertex-f),W=t.position[G],q=t.position[G+1],K=t.position[G+2];w[B]+=Math.sqrt((W-U)*(W-U)+(q-R)*(q-R)+(K-F)*(K-F))}t.uv[2*i.vertex]=C/x,t.uv[2*i.vertex+1]=w[B]/x,T=U,S=R,i.vertex++}if(1<v&&A%v||1===v&&1<=A)for(var D=0;D<6;D++){var H=(ct[D][0]+B*c)%f,N=ct[D][1]+M;t.indices[i.index++]=(N-1)*f+H+g}}M++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?h-d:d,J=0,Y=void 0,$=void 0,tt=0;tt<l;tt++)for(var et=0;et<c;et++){var nt=2*((tt+et)%l+n),rt=a[nt],it=a[nt+1];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=X,(0<tt||0<et)&&(J+=Math.sqrt((Y-rt)*(Y-rt)+($-it)*($-it))),t.uv[2*i.vertex]=J/x,t.uv[2*i.vertex+1]=X/x,Y=rt,$=it,i.vertex++}for(var ot=0<d?p*v+1:1,at=0;at<l;at++)for(var st=0;st<6;st++){var ht=(ct[st][0]+at*c)%f,ut=ct[st][1]+ot;t.indices[i.index++]=(ut-1)*f+ht+g}}function q(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,h=t.depth;if(!(o.length<=4)){for(var u=n.vertex,l=i.length,c=0;c<l;c++)e.indices[n.index++]=u+i[c];for(var f=Math.max(s.width,s.height),v=0;v<(r.excludeBottom?1:2);v++)for(var d=0;d<a.length;d+=2){var p=a[d],g=a[d+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-v)*h,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<l;y+=3)for(var m=0;m<3;m++)e.indices[n.index++]=u+x+i[y+2-m]}}function K(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,h=o.holes,u=o.depth,l=s.length/2,c=0<Math.min(u/2,e.bevelSize)?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=l*(e.excludeBottom?1:2);for(var f=2+2*c,v=0,d=0,p=0;p<(h?h.length:0)+1;p++){n+=6*((d=0===p?h&&h.length?h[0]:l:(v=h[p-1],h[p]||l))-v)*(f-1);var g=(d-v)*(e.smoothSide?1:2);r+=g*f+(e.smoothBevel?0:c*g*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<t.length;m++)q(t[m],x,y,e);for(var b=0;b<t.length;b++){var _=t[b],M=(h=_.holes,(s=_.vertices).length/2),w=0,j=h&&h.length?h[0]:M;if(W(x,t[b],w,j,y,e),h)for(var O=0;O<h.length;O++)w=h[O],j=h[O+1]||M,W(x,t[b],w,j,y,e)}for(var A=0;A<x.uv.length;A++){var C=x.uv[A];0<C&&Math.round(C)===C?x.uv[A]=1:x.uv[A]=C%1}return x.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r,i,o,a,s,h,u,l,c,f,v,d,p,g,x,y=[],m=[],b=[],_=[],M=[],w=[],j=t.length,O=new Float32Array(e.length),A=0;A<j;){var C=3*t[A++],T=3*t[A++],S=3*t[A++];n(y,e[C],e[C+1],e[C+2]),n(m,e[T],e[T+1],e[T+2]),n(b,e[S],e[S+1],e[S+2]),z(_,y,m),z(M,m,b),r=w,o=M,a=(i=_)[0],s=i[1],h=i[2],u=o[0],l=o[1],c=o[2],r[0]=s*c-h*l,r[1]=h*u-a*c,r[2]=a*l-s*u;for(var B=0;B<3;B++)O[C+B]=O[C+B]+w[B],O[T+B]=O[T+B]+w[B],O[S+B]=O[S+B]+w[B]}for(var V=0;V<O.length;)n(w,O[V],O[V+1],O[V+2]),d=(v=f=w)[0],p=v[1],g=v[2],x=Math.sqrt(d*d+p*p+g*g),f[0]=d/x,f[1]=p/x,f[2]=g/x,O[V++]=w[0],O[V++]=w[1],O[V++]=w[2];return O}(x.indices,x.position),x.boundingRect=t[0]&&t[0].rect,x}function D(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],h=i[a-1][1],u=0,l=0;l<a;l++){var c=i[l][0],f=i[l][1],v=c-s,d=f-h;e<(u+=Math.sqrt(v*v+d*d))&&(o.push(i[l]),u=0),s=c,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}function H(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];3<=(i=o(i,e,!0)).length&&n.push(i)}return 0<n.length?n:null}function N(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)Q(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},function(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){var n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}(e);for(var o,a=[],s=e.translate||[0,0],h=e.scale||[1,1],u=e.boundingRect,l={x:u.x*h[0]+s[0],y:u.y*h[1]+s[1],width:u.width*h[0],height:u.height*h[1]},c=Math.min(u.width,u.height)/1e5,f=0;f<t.length;f++){var v=D(t[f],c);if(v){var d=e.simplify/Math.max(h[0],h[1]);if(0<d&&(v=H(v,d)),v){for(var p=M.flatten(v),g=p.vertices,x=p.holes,y=p.dimensions,m=0;m<g.length;)g[m]=g[m++]*h[0]+s[0],g[m]=g[m++]*h[1]+s[1];if(G(g,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<e.bevelSize?R(g,x,e.bevelSize,null,!0):g,_=(void 0===(o=y)&&(o=2),M(b,x,o));a.push({indices:_,vertices:g,topVertices:b,holes:x,rect:l,depth:"function"==typeof e.depth?e.depth(f):e.depth})}}}return K(a,e)}function Q(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}function X(t){for(var e=new Float32Array(t),n=[],r=0,i=e.length;r<i;r+=2){var o=e[r],a=e[r+1];n.push([o,a])}return n}function J(t){for(var e=0,n=0;n<t.length;++n){e+=t[n].length}for(var r=new Float32Array(e),i=0,o=0;o<t.length;++o)r.set(t[o],i),i+=t[o].length;return r}t.initialize=function(){},t.onmessage=function(t,e){var n=t.data,r=n.type,i=n.datas;if("Polygon"===r){!function(t){for(var e=t.length,n=0;n<e;n++)for(var r=t[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],s=0,h=a.length;s<h;s++)t[n].data[i][s]=X(a[s])}(i);var o=function(t){for(var e=t.length,n=[],r=[],i=[],o=0,a=0,s=0,h=0,u=0;u<e;u++){var l=(m=t[u],b=m.data,_=m.height,M=N(b,{depth:_}),w=M.position,j=M.normal,O=M.uv,A=M.indices,{position:w,normal:j,uv:O,indices:A}),c=l.position,f=l.normal,v=l.uv,d=l.indices;r.push(l);var p=d.length/3;i[u]=[o+1,o+p],o+=p;var g=c.length/3,x=f.length/3,y=v.length/2;n[u]={position:{count:g,start:a,end:a+3*g},normal:{count:x,start:s,end:s+3*x},uv:{count:y,start:h,end:h+2*y},hide:!1},a+=3*g,s+=3*x,h+=2*y}var m,b,_,M,w,j,O,A,C=function(t){for(var e={},n=0;n<t.length;++n){var r=t[n];for(var i in r)void 0===e[i]&&(e[i]=[]),e[i].push(r[i])}var o={},a=0,s=[];for(var h in e)if("indices"===h)for(var u=e[h],l=0,c=u.length;l<c;l++){for(var f=u[l],v=0,d=f.length;v<d;v++)s.push(f[v]+a);a+=e.position[l].length/3}else{var p=J(e[h]);if(!p)return null;o[h]=p}return o.indices=new Uint32Array(s),o}(r),T=C.position,S=C.normal,B=C.uv,V=C.indices;return{position:T.buffer,normal:S.buffer,uv:B.buffer,indices:V.buffer,faceMap:i,geometriesAttributes:n}}(i);e(null,o,[o.position,o.normal,o.uv,o.indices])}},Object.defineProperty(t,"__esModule",{value:!0})});var i=function(t){function e(){return t.apply(this,arguments)||this}return r(e,t),e.prototype.addTo=function(t){if(t instanceof l)return t.on("mousemove",this.onMouseMove,this),t.on("mouseout",this.onMouseOut,this),this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this;throw new Error("Invalid BaseObject the tooltip is added to.")},e}(U.ui.ToolTip),o={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1},l=function(n){function t(t){var e;return(e=n.call(this)||this).isBaseObject=!0,e.isAdd=!1,e.object3d=null,e.options={},e.toolTip=null,e.infoWindow=null,e._mouseover=!1,e._showPlayer=null,e._vt=null,void 0===t&&(t=U.Util.GUID()),e.id=t,e}r(t,n);var e=t.prototype;return e.addTo=function(t){return t instanceof Se?t.addMesh(this):console.error("layer only support maptalks.ThreeLayer"),this},e.remove=function(){var t=this.getLayer();return t&&t.removeMesh(this),this},e.getObject3d=function(){return this.object3d},e.getId=function(){return this.id},e.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},e.getType=function(){return this.constructor.name},e.getOptions=function(){return this.options},e.getProperties=function(){return(this.options||{}).properties},e.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},e.getLayer=function(){return this.options.layer},e.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},e.getCenter=function(){var t=this.getOptions(),e=t.coordinate,n=t.lineString,r=t.polygon;if(e)return e;var i=r||n;return i&&i.getCenter?i.getCenter():void 0},e.getAltitude=function(){return this.getOptions().altitude},e.setAltitude=function(t){if(U.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;this.getObject3d().position.z=e,this.options.altitude=t}return this},e.show=function(){return this.getObject3d().visible=!0,this._fire("show"),this},e.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this},e.isVisible=function(){return!!this.getObject3d().visible},e.getSymbol=function(){return this.getObject3d().material},e.setSymbol=function(t){if(t&&t instanceof R.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;var e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this},e.setInfoWindow=function(t){return this.infoWindow=new U.ui.InfoWindow(t),this},e.getInfoWindow=function(){return this.infoWindow},e.openInfoWindow=function(t){return t&&this.infoWindow&&this.infoWindow.show(t),this},e.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},e.removeInfoWindow=function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},e.setToolTip=function(t,e){return this.toolTip=new i(t,e),this},e.getToolTip=function(){return this.toolTip},e.openToolTip=function(t){return t&&this.toolTip&&this.toolTip.show(t),this},e.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},e.removeToolTip=function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this},e.animateShow=function(t,n){var r=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),U.Util.isFunction(t)&&(n=t={});var e=t.duration||1e3,i=t.easing||"out",o=this._showPlayer=U.animation.Animation.animate({scale:1},{duration:e,easing:i},function(t){var e=t.styles.scale;0<e&&r.getObject3d().scale.set(1,1,e),n&&n(t,e)});return o.play(),o},e.getMinZoom=function(){return this.getOptions().minZoom},e.getMaxZoom=function(){return this.getOptions().maxZoom},e.isAsynchronous=function(){return this.getOptions().asynchronous},e.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},e.config=function(){return this},e._initOptions=function(t){return this.options=U.Util.extend({},o,t),this},e._createMesh=function(t,e){return this.object3d=new R.Mesh(t,e),this.object3d.__parent=this},e._createGroup=function(){return this.object3d=new R.Group,this.object3d.__parent=this},e._createLine=function(t,e){return this.object3d=new R.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},e._createPoints=function(t,e){return this.object3d=new R.Points(t,e),this.object3d.__parent=this},e._createLineSegments=function(t,e){return this.object3d=new R.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},t}(U.Eventable(function(){})),a=parseInt(R.REVISION);function Z(t,e,n){return 109<a?t.setAttribute(e,n):t.addAttribute(e,n),t}function F(t){for(var e={},n=0;n<t.length;++n){var r=t[n];for(var i in r)void 0===e[i]&&(e[i]=[]),e[i].push(r[i])}var o={},a=0,s=[];for(var h in e)if("indices"===h)for(var u=e[h],l=0,c=u.length;l<c;l++){for(var f=u[l],v=0,d=f.length;v<d;v++)s.push(f[v]+a);a+=e.position[l].length/3}else{var p=M(e[h]);if(!p)return null;o[h]=p}o.indices=new Uint32Array(s);var g=o.position,x=o.normal,y=o.uv,m=o.indices,b=new R.BufferGeometry,_=new Float32Array(g.length);return _.fill(1,0,g.length),Z(b,"color",new R.BufferAttribute(_,3)),Z(b,"normal",new R.BufferAttribute(x,3)),Z(b,"position",new R.BufferAttribute(g,3)),y&&y.length&&Z(b,"uv",new R.BufferAttribute(y,2)),b.setIndex(new R.BufferAttribute(m,1)),b}function M(t){for(var e=0,n=0;n<t.length;++n){e+=t[n].length}for(var r=new Float32Array(e),i=0,o=0;o<t.length;++o)r.set(t[o],i),i+=t[o].length;return r}var y={},m="-";function G(t,e){void 0===e&&(e=!0);var n,r=t.height,i=t.radialSegments,o=t.radius,a=t._radius,s=t._height;if(!e){var h=new R.CylinderBufferGeometry(o,o,r,i,1);h.rotateX(Math.PI/2);for(var u=h.attributes.position.array,l=0,c=u.length;l<c;l+=3)u[l+2]+=r/2;return h}for(var f=0;f<=4;f++){var v=[s+f,a,i].join(m).toString();if(n=y[v])break;if(v=[s-f,a,i].join(m).toString(),n=y[v])break}if(n)return n;var d=[s,a,i].join(m).toString();(n=y[d]=new R.CylinderBufferGeometry(o,o,r,i,1)).rotateX(Math.PI/2);for(var p=n.attributes.position.array,g=0,x=p.length;g<x;g+=3)p[g+2]+=r/2;return n}function W(t,e,n,r,i){void 0===r&&(r="y"),void 0===i&&(i=0);var o=0;"y"===r?o=1:"z"===r&&(o=2);for(var a=t.attributes.position.array,s=a.length,h=e instanceof R.Color?e:new R.Color(e),u=new R.Color(n),l=[],c=0;c<s;c+=3){i<a[c+o]?l.push(u.r,u.r,u.b):l.push(h.r,h.r,h.b)}return Z(t,"color",new R.Float32BufferAttribute(l,3,!0)),l}var p={radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},q=function(d){function t(t,e,n,r){var i;e=U.Util.extend({},p,e,{layer:r,coordinate:t}),(i=d.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.radius,h=o.topColor,u=o.bottomColor,l=o.altitude;e.height=r.distanceToVector3(a,a).x,e.radius=r.distanceToVector3(s,s).x,e._radius=i.options.radius,e._height=i.options.height,i._h=e.height;var c=G(e);h&&!n.map&&(W(c,u,h,"z",e.height/2),n.vertexColors=R.VertexColors),i._createMesh(c,n);var f=r.distanceToVector3(l,l).x,v=r.coordinateToVector3(t,f);return i.getObject3d().position.copy(v),i}return r(t,d),t}(l),w=n,e=n;function n(t,e,n){n=n||2;var r,i,o,a,s,h,u,l=e&&e.length,c=l?e[0]*n:t.length,f=g(t,0,c,n,!0),v=[];if(!f||f.next===f.prev)return v;if(l&&(f=function(t,e,n,r){var i,o,a,s,h,u=[];for(i=0,o=e.length;i<o;i++)a=e[i]*r,s=i<o-1?e[i+1]*r:t.length,(h=g(t,a,s,r,!1))===h.next&&(h.steiner=!0),u.push(A(h));for(u.sort(_),i=0;i<u.length;i++)j(u[i],n),n=x(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var d=n;d<c;d+=n)(s=t[d])<r&&(r=s),(h=t[d+1])<i&&(i=h),o<s&&(o=s),a<h&&(a=h);u=0!==(u=Math.max(o-r,a-i))?1/u:0}return b(f,v,n,r,i,u),v}function g(t,e,n,r,i){var o,a;if(i===0<P(t,e,n,r))for(o=e;o<n;o+=r)a=s(o,t[o],t[o+1],a);else for(o=n-r;e<=o;o-=r)a=s(o,t[o],t[o+1],a);return a&&S(a,a.next)&&(k(a),a=a.next),a}function x(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!S(r,r.next)&&0!==T(r.prev,r,r.next))r=r.next;else{if(k(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function b(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;for(;null===i.z&&(i.z=O(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,h,u=1;do{for(n=t,o=t=null,a=0;n;){for(a++,r=n,e=s=0;e<u&&(s++,r=r.nextZ);e++);for(h=u;0<s||0<h&&r;)0!==s&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,s--):(r=(i=r).nextZ,h--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,u*=2}while(1<a)}(i)}(t,r,i,o);for(var s,h,u=t;t.prev!==t.next;)if(s=t.prev,h=t.next,o?f(t,r,i,o):c(t))e.push(s.i/n),e.push(t.i/n),e.push(h.i/n),k(t),t=h.next,u=h.next;else if((t=h)===u){a?1===a?b(t=v(x(t),e,n),e,n,r,i,o,2):2===a&&d(t,e,n,r,i,o):b(x(t),e,n,r,i,o,1);break}}}function c(t){var e=t.prev,n=t,r=t.next;if(0<=T(e,n,r))return!1;for(var i=t.next.next;i!==t.prev;){if(C(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=T(i.prev,i,i.next))return!1;i=i.next}return!0}function f(t,e,n,r){var i=t.prev,o=t,a=t.next;if(0<=T(i,o,a))return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,h=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,c=O(s,h,e,n,r),f=O(u,l,e,n,r),v=t.prevZ,d=t.nextZ;v&&v.z>=c&&d&&d.z<=f;){if(v!==t.prev&&v!==t.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=T(v.prev,v,v.next))return!1;if(v=v.prevZ,d!==t.prev&&d!==t.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=T(d.prev,d,d.next))return!1;d=d.nextZ}for(;v&&v.z>=c;){if(v!==t.prev&&v!==t.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=T(v.prev,v,v.next))return!1;v=v.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&C(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=T(d.prev,d,d.next))return!1;d=d.nextZ}return!0}function v(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!S(i,o)&&B(i,r,r.next,o)&&V(i,o)&&V(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),k(r),k(r.next),r=t=o),r=r.next}while(r!==t);return x(r)}function d(t,e,n,r,i,o){var a,s,h=t;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&(s=u,(a=h).next.i!==s.i&&a.prev.i!==s.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&B(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(a,s)&&(V(a,s)&&V(s,a)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==t;);return r}(a,s)&&(T(a.prev,a,s.prev)||T(a,s.prev,s))||S(a,s)&&0<T(a.prev,a,a.next)&&0<T(s.prev,s,s.next)))){var l=z(h,u);return h=x(h,h.next),l=x(l,l.next),b(h,e,n,r,i,o),void b(l,e,n,r,i,o)}u=u.next}h=h.next}while(h!==t)}function _(t,e){return t.x-e.x}function j(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&a<s){if((a=s)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var h,u=n,l=n.x,c=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=l&&i!==r.x&&C(o<c?i:a,o,l,c,o<c?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),V(r,t)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&(d=r,T((v=n).prev,v,d.prev)<0&&T(d.next,v,v.next)<0)))&&(n=r,f=h)),r=r.next,r!==u;);var v,d;return n}(t,e)){var n=z(e,t);x(n,n.next)}}function O(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function A(t){for(var e=t,n=t;(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),(e=e.next)!==t;);return n}function C(t,e,n,r,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(r-s)-(n-a)*(e-s)&&0<=(n-a)*(o-s)-(i-a)*(r-s)}function T(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function S(t,e){return t.x===e.x&&t.y===e.y}function B(t,e,n,r){var i=u(T(t,e,n)),o=u(T(t,e,r)),a=u(T(n,r,t)),s=u(T(n,r,e));return i!==o&&a!==s||(!(0!==i||!h(t,n,e))||(!(0!==o||!h(t,r,e))||(!(0!==a||!h(n,t,r))||!(0!==s||!h(n,e,r)))))}function h(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function u(t){return 0<t?1:t<0?-1:0}function V(t,e){return T(t.prev,t,t.next)<0?0<=T(t,e,t.next)&&0<=T(t,t.prev,e):T(t,e,t.prev)<0||T(t,t.next,e)<0}function z(t,e){var n=new I(t.i,t.x,t.y),r=new I(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function s(t,e,n,r){var i=new I(t,e,n);return r?(i.next=r.next,(i.prev=r).next.prev=i,r.next=i):(i.prev=i).next=i,i}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function I(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function P(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function L(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);1<s?(r=n[0],i=n[1]):0<s&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function K(t,e){var n=t.length-1,r=[t[0]];return function t(e,n,r,i,o){for(var a,s=i,h=n+1;h<r;h++){var u=L(e[h],e[n],e[r]);s<u&&(a=h,s=u)}i<s&&(1<a-n&&t(e,n,a,i,o),o.push(e[a]),1<r-a&&t(e,a,r,i,o))}(t,0,n,e,r),r.push(t[n]),r}function D(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=K(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],h=[s],u=1,l=t.length;u<l;u++)n=t[u],i=s,o=(r=n)[0]-i[0],a=r[1]-i[1],e<o*o+a*a&&(h.push(n),s=n);return s!==n&&h.push(n),h}(t,r),r)}function H(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function N(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function Q(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}n.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(P(t,0,o,n));if(i)for(var s=0,h=e.length;s<h;s++){var u=e[s]*n,l=s<h-1?e[s+1]*n:t.length;a-=Math.abs(P(t,u,l,n))}var c=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,v=r[s+1]*n,d=r[s+2]*n;c+=Math.abs((t[f]-t[d])*(t[v+1]-t[f+1])-(t[f]-t[v])*(t[d+1]-t[f+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);0<i&&(r+=t[i-1].length,n.holes.push(r))}return n},w.default=e;var X=[];function lt(t,e,n,r){var i,o,a,s,h,u,l,c,f,v,d,p=(o=n,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(p)*r;return N(X,n,e,-p),h=(s=a=X)[0],u=s[1],l=s[2],c=Math.sqrt(h*h+u*u+l*l),a[0]=h/c,a[1]=u/c,a[2]=l/c,f=t,v=e,d=Math.cos(g),f[0]=v[0]*d,f[1]=v[1]*d,f[2]=v[2]*d,N(t,t,X,Math.sin(g)),t}function J(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],h=t[o],u=t[o+1];i=o,o+=2,r+=a*u-h*s}return r}var Y=[],$=[],tt=[];function et(t,e,n,r,i,o,a,s){var h,u,l,c,f,v=null!=a,d=i,p=null;v&&(p=new Uint32Array(r-n));for(var g=n;g<r;g++){var x=g===r-1?n:g+1,y=g===n?r-1:g-1,m=t[2*y],b=t[2*y+1],_=t[2*g],M=t[2*g+1],w=t[2*x],j=t[2*x+1];if(Y[0]=_-m,Y[1]=M-b,$[0]=w-_,$[1]=j-M,H(Y,Y),H($,$),v&&(p[g]=d),s||g!==n)if(s||g!==r-1){c=$,f=Y,(l=tt)[0]=c[0]+f[0],l[1]=c[1]+f[1];var O=tt[1];tt[1]=-tt[0],tt[0]=O,H(tt,tt);var A=(u=$,(h=tt)[0]*u[0]+h[1]*u[1]),C=Math.sqrt(1-A*A),T=o*Math.min(10,1/C);if(v&&a<1/C&&o*A<0){var S=_+tt[0]*o,B=M+tt[1]*o,V=Math.acos(C)/2,z=Math.tan(V)*Math.abs(o);e[2*d]=S+tt[1]*z,e[2*d+1]=B-tt[0]*z,e[2*++d]=S-tt[1]*z,e[2*d+1]=B+tt[0]*z,d++}else e[2*d]=_+tt[0]*T,e[2*d+1]=M+tt[1]*T,d++}else tt[0]=Y[1],tt[1]=-Y[0],H(tt,tt),e[2*d]=_+tt[0]*o,e[2*d+1]=M+tt[1]*o,d++;else tt[0]=$[1],tt[1]=-$[0],H(tt,tt),e[2*d]=_+tt[0]*o,e[2*d+1]=M+tt[1]*o,d++}return p}function nt(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(et(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];et(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function rt(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,h=t[a];t[a]=t[s],t[s]=h}return t}function it(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;0<J(t,r,i)&&rt(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)J(t,r=e[o-1],i=e[o]||n)<0&&rt(t,2,r,i)}function ot(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){var n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}var ct=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function at(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,h=e.depth,u=e.rect,l=r-n,c=o.smoothSide?1:2,f=l*c,v=o.smoothBevel?1:2,d=Math.min(h/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,x=Math.max(u.width,u.height);if(0<d)for(var y=[0,0,1],m=[],b=[0,0,-1],_=[],M=0,w=new Float32Array(l),j=0;j<2;j++)for(var O=0===j?h-d:d,A=0;A<=p*v;A++){for(var C=0,T=void 0,S=void 0,B=0;B<l;B++){for(var V=0;V<c;V++){var z=2*((B+V)%l+n);m[0]=a[z]-s[z],m[1]=a[z+1]-s[z+1],m[2]=0;var k=Math.sqrt(m[0]*m[0]+m[1]*m[1]);m[0]/=k,m[1]/=k;var I=(Math.floor(A/v)+A%v)/p;0===j?lt(_,y,m,I):lt(_,m,b,I);var P=0===j?I:1-I,L=d*Math.sin(P*Math.PI/2),E=k*Math.cos(P*Math.PI/2),Z=d*k/Math.sqrt(L*L+E*E),U=_[0]*Z+s[z],R=_[1]*Z+s[z+1],F=_[2]*Z+O;if(t.position[3*i.vertex]=U,t.position[3*i.vertex+1]=R,t.position[3*i.vertex+2]=F,(0<B||0<V)&&(C+=Math.sqrt((T-U)*(T-U)+(S-R)*(S-R))),0<A||0<j){var G=3*(i.vertex-f),W=t.position[G],q=t.position[G+1],K=t.position[G+2];w[B]+=Math.sqrt((W-U)*(W-U)+(q-R)*(q-R)+(K-F)*(K-F))}t.uv[2*i.vertex]=C/x,t.uv[2*i.vertex+1]=w[B]/x,T=U,S=R,i.vertex++}if(1<v&&A%v||1===v&&1<=A)for(var D=0;D<6;D++){var H=(ct[D][0]+B*c)%f,N=ct[D][1]+M;t.indices[i.index++]=(N-1)*f+H+g}}M++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?h-d:d,J=0,Y=void 0,$=void 0,tt=0;tt<l;tt++)for(var et=0;et<c;et++){var nt=2*((tt+et)%l+n),rt=a[nt],it=a[nt+1];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=X,(0<tt||0<et)&&(J+=Math.sqrt((Y-rt)*(Y-rt)+($-it)*($-it))),t.uv[2*i.vertex]=J/x,t.uv[2*i.vertex+1]=X/x,Y=rt,$=it,i.vertex++}for(var ot=0<d?p*v+1:1,at=0;at<l;at++)for(var st=0;st<6;st++){var ht=(ct[st][0]+at*c)%f,ut=ct[st][1]+ot;t.indices[i.index++]=(ut-1)*f+ht+g}}function st(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,h=t.depth;if(!(o.length<=4)){for(var u=n.vertex,l=i.length,c=0;c<l;c++)e.indices[n.index++]=u+i[c];for(var f=Math.max(s.width,s.height),v=0;v<(r.excludeBottom?1:2);v++)for(var d=0;d<a.length;d+=2){var p=a[d],g=a[d+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-v)*h,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var x=o.length/2,y=0;y<l;y+=3)for(var m=0;m<3;m++)e.indices[n.index++]=u+x+i[y+2-m]}}function ht(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,h=o.holes,u=o.depth,l=s.length/2,c=0<Math.min(u/2,e.bevelSize)?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=l*(e.excludeBottom?1:2);for(var f=2+2*c,v=0,d=0,p=0;p<(h?h.length:0)+1;p++){n+=6*((d=0===p?h&&h.length?h[0]:l:(v=h[p-1],h[p]||l))-v)*(f-1);var g=(d-v)*(e.smoothSide?1:2);r+=g*f+(e.smoothBevel?0:c*g*2)}}for(var x={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},y={vertex:0,index:0},m=0;m<t.length;m++)st(t[m],x,y,e);for(var b=0;b<t.length;b++){var _=t[b],M=(h=_.holes,(s=_.vertices).length/2),w=0,j=h&&h.length?h[0]:M;if(at(x,t[b],w,j,y,e),h)for(var O=0;O<h.length;O++)w=h[O],j=h[O+1]||M,at(x,t[b],w,j,y,e)}for(var A=0;A<x.uv.length;A++){var C=x.uv[A];0<C&&Math.round(C)===C?x.uv[A]=1:x.uv[A]=C%1}return x.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r,i,o,a,s,h,u,l,c,f,v,d,p,g,x,y=[],m=[],b=[],_=[],M=[],w=[],j=t.length,O=new Float32Array(e.length),A=0;A<j;){var C=3*t[A++],T=3*t[A++],S=3*t[A++];n(y,e[C],e[C+1],e[C+2]),n(m,e[T],e[T+1],e[T+2]),n(b,e[S],e[S+1],e[S+2]),Q(_,y,m),Q(M,m,b),r=w,o=M,a=(i=_)[0],s=i[1],h=i[2],u=o[0],l=o[1],c=o[2],r[0]=s*c-h*l,r[1]=h*u-a*c,r[2]=a*l-s*u;for(var B=0;B<3;B++)O[C+B]=O[C+B]+w[B],O[T+B]=O[T+B]+w[B],O[S+B]=O[S+B]+w[B]}for(var V=0;V<O.length;)n(w,O[V],O[V+1],O[V+2]),d=(v=f=w)[0],p=v[1],g=v[2],x=Math.sqrt(d*d+p*p+g*g),f[0]=d/x,f[1]=p/x,f[2]=g/x,O[V++]=w[0],O[V++]=w[1],O[V++]=w[2];return O}(x.indices,x.position),x.boundingRect=t[0]&&t[0].rect,x}function ut(t,e,n){for(var r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1],h=0,u=0;h<i;h++)o[u++]=t[h][0]*s[0]+a[0],o[u++]=t[h][1]*s[1]+a[1];J(o,0,i)<0&&rt(o,2,0,i);var l=[],c=[],f=n.miterLimit,v=et(o,c,0,i,0,-r/2,f,!1);rt(o,2,0,i);for(var d=et(o,l,0,i,0,-r/2,f,!1),p=(l.length+c.length)/2,g=new Float32Array(2*p),x=0,y=c.length/2,m=0;m<c.length;m++)g[x++]=c[m];for(var b=0;b<l.length;b++)g[x++]=l[b];for(var _=new(65535<p?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),M=0,w=0;w<i-1;w++){var j=w+1;_[M++]=y-1-v[w],_[M++]=y-1-v[w]-1,_[M++]=d[w]+1+y,_[M++]=y-1-v[w],_[M++]=d[w]+1+y,_[M++]=d[w]+y,d[j]-d[w]==2?(_[M++]=d[w]+2+y,_[M++]=d[w]+1+y,_[M++]=y-v[j]-1):v[j]-v[w]==2&&(_[M++]=d[j]+y,_[M++]=y-1-(v[w]+1),_[M++]=y-1-(v[w]+2))}var O=0<n.bevelSize?nt(g,[],n.bevelSize,null,!0):g,A=n.boundingRect;return{vertices:g,indices:_,topVertices:O,rect:{x:A.x*s[0]+a[0],y:A.y*s[1]+a[1],width:A.width*s[0],height:A.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function ft(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],h=i[a-1][1],u=0,l=0;l<a;l++){var c=i[l][0],f=i[l][1],v=c-s,d=f-h;e<(u+=Math.sqrt(v*v+d*d))&&(o.push(i[l]),u=0),s=c,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}function vt(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];3<=(i=D(i,e,!0)).length&&n.push(i)}return 0<n.length?n:null}function dt(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)pt(t[i],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},ot(e);var o=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);for(var a=[],s=0;s<t.length;s++){var h=t[s],u=e.simplify/Math.max(o[0],o[1]);0<u&&(h=D(h,u,!0)),a.push(ut(h,s,e))}return ht(a,e)}function pt(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var gt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function xt(t){return void 0===t&&(t={}),(t.geometry||{}).type}function yt(t){void 0===t&&(t={});var e=xt(t);if(e)for(var n=0,r=gt.length;n<r;n++)if(gt[n]===e)return!0;return!1}function mt(t){void 0===t&&(t={});var e=xt(t);return!(!e||e!==gt[4]&&e!==gt[5])}function bt(t){void 0===t&&(t={});var e=xt(t);return!(!e||e!==gt[2]&&e!==gt[3])}function _t(t){void 0===t&&(t={});var e=xt(t);return!(!e||e!==gt[0]&&e!==gt[1])}function Mt(t){return void 0===t&&(t={}),(t.geometry||{}).coordinates||[]}function wt(t){void 0===t&&(t={});var e=xt(t);if(!e)return null;var n=(t.geometry||{}).coordinates;if(!n)return null;var r=[];switch(e){case"Point":r.push(n);break;case"MultiPoint":case"LineString":for(var i=0,o=n.length;i<o;i++)r.push(n[i]);break;case"MultiLineString":case"Polygon":for(var a=0,s=n.length;a<s;a++)for(var h=0,u=n[a].length;h<u;h++)r.push(n[a][h]);break;case"MultiPolygon":for(var l=0,c=n.length;l<c;l++)for(var f=0,v=n[l].length;f<v;f++)for(var d=0,p=n[l][f].length;d<p;d++)r.push(n[l][f][d])}for(var g=1/0,x=1/0,y=-1/0,m=-1/0,b=0,_=r.length;b<_;b++){var M=r[b],w=M[0],j=M[1];g=Math.min(g,w),x=Math.min(x,j),y=Math.max(y,w),m=Math.max(m,j)}return new U.Coordinate((g+y)/2,(x+m)/2)}function jt(t){void 0===t&&(t={});var e=xt(t);if(!e)return null;var n=t.geometry||{},r=t.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,h=i.length;s<h;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(t);return a}var Ot=",";function At(t,e,n){var r=[],i=[];if(Array.isArray(t)&&t[0]instanceof R.Vector3)for(var o=0,a=t.length;o<a;o++){var s=t[o];r.push(s.x,s.y,s.z),i.push(s)}else{Array.isArray(t)&&(t=new U.LineString(t));var h,u;u=yt(t)?(h=Mt(t),wt(t)):(h=t.getCoordinates(),t.getCenter());for(var l=e.coordinateToVector3(n||u),c=0,f=h.length;c<f;c++){var v=h[c];Array.isArray(v)&&(v=new U.Coordinate(v));var d=e.coordinateToVector3(v,0).sub(l);r.push(d.x,d.y,d.z),i.push(d)}}return{positions:r,positionsV:i}}function Ct(t,e,n,r){for(var i=[],o=[],a=[],s=0,h=t.length;s<h;s++)for(var u=t[s],l=0,c=u.length;l<c;l++){var f=u[l];if(0<a.length)f.join(Ot).toString()!==a[a.length-1].join(Ot).toString()&&a.push(f);else a.push(f)}for(var v=0,d=a.length;v<d;v++){var p=a[v],g=void 0,x=p.join(Ot).toString();g=n&&n[x]?n[x]:e.coordinateToVector3(p,0).sub(r),o.push(g),i.push(g.x,g.y,g.z)}return{positions:i,positionsV:o,lnglats:a}}function Tt(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=At(t,r,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var u=o[s];a.push([u.x,u.y])}var l=dt([a],{lineWidth:e,depth:n}),c=l.indices;return{position:l.position,normal:l.normal,indices:c}}var St={altitude:0,colors:null},Bt=function(d){function t(t,e,n,r){var i;e=U.Util.extend({},St,e,{layer:r,lineString:t}),(i=d.call(this)||this)._initOptions(e);var o=At(t,r).positions,a=new R.BufferGeometry;Z(a,"position",new R.Float32BufferAttribute(o,3));var s,h,u=(s=e.colors,h=[],s&&s.length&&s.forEach(function(t){t=t instanceof R.Color?t:new R.Color(t),h.push(t.r,t.g,t.b)}),h);u&&u.length&&(Z(a,"color",new R.Float32BufferAttribute(u,3)),n.vertexColors=R.VertexColors),i._createLine(a,n);var l=e.altitude,c=yt(t)?wt(t):t.getCenter(),f=r.distanceToVector3(l,l).x,v=r.coordinateToVector3(c,f);return i.getObject3d().position.copy(v),i}return r(t,d),t}(l),Vt={width:3,height:1,altitude:0},zt=function(v){function t(t,e,n,r){var i;e=U.Util.extend({},Vt,e,{layer:r,lineString:t}),(i=v.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.width;e.height=r.distanceToVector3(a,a).x,e.width=r.distanceToVector3(s,s).x;var h=function(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=At(t,r,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var u=o[s];a.push([u.x,u.y])}var l=dt([a],{lineWidth:e,depth:n}),c=l.indices,f=l.position,v=l.normal,d=new R.BufferGeometry;return Z(d,"position",new R.Float32BufferAttribute(f,3)),Z(d,"normal",new R.Float32BufferAttribute(v,3)),d.setIndex(new R.Uint32BufferAttribute(c,1)),d}(t,e.width,e.height,r);i._createMesh(h,n);var u=e.altitude,l=yt(t)?wt(t):t.getCenter(),c=r.distanceToVector3(u,u).x,f=r.coordinateToVector3(l,c);return i.getObject3d().position.copy(f),i}return r(t,v),t}(l);function kt(t,e,n,r){var i=Lt(t,n,r);if(!i)return null;var o=function(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)pt(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},ot(e);for(var o,a=[],s=e.translate||[0,0],h=e.scale||[1,1],u=e.boundingRect,l={x:u.x*h[0]+s[0],y:u.y*h[1]+s[1],width:u.width*h[0],height:u.height*h[1]},c=Math.min(u.width,u.height)/1e5,f=0;f<t.length;f++){var v=ft(t[f],c);if(v){var d=e.simplify/Math.max(h[0],h[1]);if(0<d&&(v=vt(v,d)),v){for(var p=w.flatten(v),g=p.vertices,x=p.holes,y=p.dimensions,m=0;m<g.length;)g[m]=g[m++]*h[0]+s[0],g[m]=g[m++]*h[1]+s[1];if(it(g,x),2!==y)throw new Error("Only 2D polygon points are supported");var b=0<e.bevelSize?nt(g,x,e.bevelSize,null,!0):g,_=(void 0===(o=y)&&(o=2),w(b,x,o));a.push({indices:_,vertices:g,topVertices:b,holes:x,rect:l,depth:"function"==typeof e.depth?e.depth(f):e.depth})}}}return ht(a,e)}(i,{depth:e=n.distanceToVector3(e,e).x});return{position:o.position,normal:o.normal,uv:o.uv,indices:o.indices}}function It(t,e,n){for(var r=t.attributes.position.array,i=r.length,o=e instanceof R.Color?e:new R.Color(e),a=new R.Color(n),s=[],h=0;h<i;h+=3){0<r[h+2]?s.push(a.r,a.r,a.b):s.push(o.r,o.r,o.b)}return Z(t,"color",new R.Float32BufferAttribute(s,3,!0)),s}function Pt(t){void 0===t&&(t=[]);for(var e=1/0,n=1/0,r=-1/0,i=-1/0,o=0,a=t.length;o<a;o++){var s=t[o],h=void 0,u=void 0;Array.isArray(s)?(h=s[0],u=s[1]):s instanceof U.Coordinate&&(h=s.x,u=s.y),e=Math.min(e,h),n=Math.min(n,u),r=Math.max(r,h),i=Math.max(i,u)}return new U.Coordinate((e+r)/2,(n+i)/2)}function Lt(e,n,r,i){if(void 0===i&&(i=!1),!e)return null;var t=[];if(e instanceof U.MultiPolygon)t=e.getGeometries().map(function(t){return Et(t,n,r||e.getCenter(),i)});else if(e instanceof U.Polygon){var o=Et(e,n,r||e.getCenter(),i);t.push(o)}else if(mt(e)){var a=wt(e);if(function(t){void 0===t&&(t={});var e=xt(t);return!!(e&&-1<e.indexOf("Multi"))}(e))for(var s=jt(e),h=0,u=s.length;h<u;h++)t.push(Et(s[h],n,r||a,i));else{var l=Et(e,n,r||a,i);t.push(l)}}return t}function Et(t,e,n,r){var i,o;if(void 0===r&&(r=!1),mt(t)){var a=Mt(t);i=a[0],o=a.slice(1,a.length),n=n||wt(t)}else i=t.getShell(),o=t.getHoles(),n=n||t.getCenter();var s,h=e.coordinateToVector3(n);s=r?new Float32Array(2*i.length):[];for(var u=0,l=i.length;u<l;u++){var c=i[u],f=e.coordinateToVector3(c).sub(h);if(r){var v=2*u;s[v]=f.x,s[v+1]=f.y}else s.push([f.x,f.y])}var d=[r?s.buffer:s];if(o&&0<o.length)for(var p=0,g=o.length;p<g;p++){for(var x=r?new Float32Array(2*o[p].length):[],y=0,m=o[p].length;y<m;y++){var b=o[p][y],_=e.coordinateToVector3(b).sub(h);if(r){var M=2*y;x[M]=_.x,x[M+1]=_.y}else x.push([_.x,_.y])}d.push(r?x.buffer:x)}return d}var Zt={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},Ut=function(d){function t(t,e,n,r){var i;e=U.Util.extend({},Zt,e,{layer:r,polygon:t}),(i=d.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.topColor,h=o.bottomColor,u=o.altitude,l=function(t,e,n,r){var i=kt(t,e,n,r),o=i.position,a=i.normal,s=i.uv,h=i.indices,u=new Float32Array(o.length);u.fill(1,0,o.length);var l=new R.BufferGeometry;return Z(l,"color",new R.BufferAttribute(u,3)),Z(l,"normal",new R.BufferAttribute(a,3)),Z(l,"position",new R.BufferAttribute(o,3)),Z(l,"uv",new R.BufferAttribute(s,2)),l.setIndex(new R.Uint32BufferAttribute(h,1)),l}(t,a,r),c=mt(t)?wt(t):t.getCenter();s&&!n.map&&(It(l,h,s),n.vertexColors=R.VertexColors),i._createMesh(l,n);var f=r.distanceToVector3(u,u).x,v=r.coordinateToVector3(c,f);return i.getObject3d().position.copy(v),i}return r(t,d),t}(l),Rt={altitude:0,coordinate:null},Ft=function(u){function t(t,e,n){var r;void 0===e&&(e={}),e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=U.Util.extend({},Rt,e,{layer:n,model:t}),(r=u.call(this)||this)._initOptions(e),r._createGroup(),r.getObject3d().add(t);var i=e,o=i.altitude,a=i.coordinate,s=n.distanceToVector3(o,o).x,h=n.coordinateToVector3(a,s);return r.getObject3d().position.copy(h),r}return r(t,u),t}(l),Gt=Math.PI/180,Wt=6378137,qt=1;function Kt(t){return t*Gt}function Dt(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=Kt(t[1]),r=Kt(e[1]),i=n-r,o=Kt(t[0])-Kt(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),n*=Wt,Math.round(1e5*n)/1e5}function Ht(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var h=0,u=r.length;h<u;h++)t.index.array[h]=r[h]}var Nt,Qt={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},Xt=function(k){function t(t,e,n,r){var i;e=U.Util.extend({},Qt,e,{layer:r,lineString:t}),(i=k.call(this)||this)._initOptions(e);for(var o,a=e,s=a.width,h=a.height,u=a.altitude,l=a.speed,c=a.chunkLength,f=a.trail,v=function(t,e){void 0===e&&(e=10),e=Math.max(e,qt),Array.isArray(t)||(t=t.getCoordinates().map(function(t){return t.toArray()}));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=Dt(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map(function(t){return[t.c1,t.c2]});if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var h,u,l,c,f,v,d,p,g,x=r.length,y=0,m=0,b=[],_=[r[0].c1];y<x;){var M=r[y],w=M.len,j=M.c2;if((m+=w)<e&&(_.push(j),y===x-1&&b.push(_),y++),m===e&&(_.push(j),m=0,b.push(_),_=[j],y++),e<m){var O=w-m+e;u=r[y],l=O,c=u.len,f=u.c1,v=u.c2,d=v[0]-f[0],p=v[1]-f[1],g=l/c,h=[f[0]+g*d,f[1]+g*p],_.push(h),b.push(_),m=0,r[y].c1=h,r[y].len=w-O,(_=[]).push(h)}}return b}(yt(t)?(o=wt(t),Mt(t)):(o=t.getCenter(),t),c),d=r.coordinateToVector3(t.getCenter()),p={},g=0,x=v.length;g<x;g++)for(var y=v[g],m=0,b=y.length;m<b;m++){var _=y[m],M=_.join(",").toString();p[M]||(p[M]=r.coordinateToVector3(_).sub(d))}var w=Ct(v.slice(0,1),r,p,d).positionsV,j=new R.BufferGeometry,O=new Float32Array(3e3),A=new Float32Array(3e3),C=new Uint16Array(1e3);Z(j,"position",new R.BufferAttribute(O,3)),Z(j,"normal",new R.BufferAttribute(A,3)),j.setIndex(new R.BufferAttribute(C,1));var T=r.distanceToVector3(s,s).x,S=r.distanceToVector3(h,h).x,B=Tt(w,T,S,r);Ht(j,B.position,B.normal,B.indices),i._createMesh(j,n);var V=r.distanceToVector3(u,u).x,z=r.coordinateToVector3(o,V);return i.getObject3d().position.copy(z),i._params={index:0,chunkLines:v,geometries:[],layer:r,trail:Math.max(1,f),lineWidth:T,depth:S,speed:Math.min(1,l),idx:0,loaded:!1,positionMap:p,centerPt:d},i._init(i._params),i}r(t,k);var e=t.prototype;return e._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,h=o.length,u=[],l=0;l<h;l++){var c=Ct(o.slice(l,l+n),e,a,s).positionsV;u.push(Tt(c,r,i,e))}this._params.geometries=u,this._params.loaded=!0},e._animation=function(){var t=this._params,e=t.index,n=t.geometries,r=t.speed,i=t.idx,o=t.chunkLines,a=t.trail,s=t.lineWidth,h=t.depth,u=t.loaded,l=t.layer,c=t.positionMap,f=t.centerPt;if(u){var v=Math.round(e);if(i<v){this._params.idx++;var d=n[v];if(!d)d=Tt(Ct(o.slice(v,v+a),l,c,f).positionsV,s,h,l),n[v]=d;Ht(this.getObject3d().geometry,d.position,d.normal,d.indices),this.getObject3d().geometry.attributes.position.needsUpdate=!0,this.getObject3d().geometry.attributes.normal.needsUpdate=!0,this.getObject3d().geometry.index.needsUpdate=!0}e>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=r}},t}(l),Jt=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),Yt=function(t){return function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var n=e.prototype;return n._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++){var r=t[e];this._proxyEvent(r)}return this},n._proxyEvent=function(t){var e=this;t.on("add",function(t){e._showGeometry(t.target,!0)}),t.on("remove",function(t){e._showGeometry(t.target,!1)}),t.on("mouseout",function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}),t.on(Jt,function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})},n._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];var a=NaN;this.getObject3d()instanceof R.LineSegments&&(a=0);for(var s=0;s<n.length;s++)for(var h=n[s],u=this._geometriesAttributes[h][e],l=u.start,c=u.end,f=l;f<c;f++)t.array[f]=a;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},n.getSelectMesh=function(){return{data:null,baseObject:null}},e}(t)},$t={name:"maptalks.three",version:"0.7.1",description:"A maptalks Layer to render with THREE.js.",license:"MIT",repository:{type:"git",url:"https://github.com/maptalks/maptalks.three.js.git"},main:"dist/maptalks.three.js",module:"dist/maptalks.three.es.js","jsnext:main":"dist/maptalks.three.es.js",scripts:{dev:"rollup -w -c rollup.config.js",build:"rollup --environment BUILD:production -c rollup.config.js","build-dev":"rollup -c rollup.config.js",preversion:"npm run lint",version:"npm run build && git add -A dist",lint:"eslint index.js src/**/*.js test/**/*.js",prepublish:"npm run lint && npm run build"},devDependencies:{"@babel/core":"^7.0.0","@babel/preset-env":"^7.0.0","babel-eslint":"^9.0.0",eslint:"^4.19.1","eslint-config-maptalks":"^0.3.0","eslint-plugin-mocha":"^5.0.0",rollup:"^0.66.1","rollup-plugin-babel":"^4.1.0-0","rollup-plugin-commonjs":"^9.1.0","rollup-plugin-json":"^4.0.0","rollup-plugin-node-resolve":"^3.3.0","rollup-plugin-uglify":"^6.0.0",three:"^0.97.0"},peerDependencies:{maptalks:">=0.39.0"},dependencies:{"geometry-extrude":"^0.1.2"}},te=function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var n=e.prototype;return n.test=function(t,e){this.send(t,null,e)},n.pushQueue=function(t){void 0===t&&(t={});var e,n=t,r=n.type,i=n.data,o=n.callback,a=n.layer,s=n.key,h=n.center;"Polygon"===r&&(e=function(t,e,n){void 0===t&&(t=[]);for(var r=t.length,i=[],o=[],a=0;a<r;a++){for(var s=t[a],h=Lt(s,n,e,!0),u=0,l=h.length;u<l;u++)for(var c=h[u],f=0,v=c.length;f<v;f++)o.push(c[f]);var d=(mt(s)?s.properties:s.getProperties()||{}).height||1;d=n.distanceToVector3(d,d).x,i.push({data:h,height:d})}return{datas:i,transfer:o}}(i,h,a)),this.send({type:r,datas:e.datas},e.transfe,function(t,e){t&&console.error(t),e.key=s,o(e)})},e}(U.worker.Actor);var ee={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},ne=function(L){function t(t,e,i,n){var o;Array.isArray(t)||(t=[t]);for(var r=[],a=t.length,s=0;s<a;s++){var h=t[s];r.push(mt(h)?wt(h):h.getCenter())}var u,l=Pt(r),c=e=U.Util.extend({},ee,e,{layer:n,polygons:t,coordinate:l}),f=c.topColor,v=c.bottomColor,d=c.altitude,p=[],g=[],x=[];if(c.asynchronous){var y=(Nt||(Nt=new te($t.name)),Nt);u=new R.BoxBufferGeometry(1e-6,1e-6,1e-6*5),y.pushQueue({type:"Polygon",layer:n,key:e.key,center:l,data:t,callback:function(t){var e=t.faceMap,n=t.geometriesAttributes;o._faceMap=e,o._geometriesAttributes=n;var r=function(t){var e=t.position,n=t.normal,r=t.uv,i=t.indices,o=new Float32Array(e.length);o.fill(1,0,e.length);var a=new R.BufferGeometry;return Z(a,"color",new R.BufferAttribute(o,3)),Z(a,"normal",new R.BufferAttribute(new Float32Array(n),3)),Z(a,"position",new R.BufferAttribute(new Float32Array(e),3)),Z(a,"uv",new R.BufferAttribute(new Float32Array(r),2)),a.setIndex(new R.BufferAttribute(new Uint32Array(i),1)),a}(t);f&&!i.map&&(It(r,v,f),i.vertexColors=R.VertexColors),o.getObject3d().geometry.dispose(),o.getObject3d().geometry=r,o.getObject3d().material.needsUpdate=!0,o._geometryCache=r.clone(),o._fire("workerload",{target:E(E(o))})}})}else{for(var m=[],b=0,_=0,M=0,w=0,j=0;j<a;j++){var O=t[j],A=kt(O,(mt(O)?O.properties:O.getProperties()||{}).height||1,n,l);m.push(A);var C=A.position,T=A.normal,S=A.uv,B=A.indices.length/3;g[j]=[b+1,b+B],b+=B;var V=C.length/3,z=T.length/3,k=S.length/2;x[j]={position:{count:V,start:_,end:_+3*V},normal:{count:z,start:M,end:M+3*z},uv:{count:k,start:w,end:w+2*k},hide:!1},_+=3*V,M+=3*z,w+=2*k}u=F(m),f&&!i.map&&(It(u,v,f),i.vertexColors=R.VertexColors)}(o=L.call(this)||this)._initOptions(e),o._createMesh(u,i);var I=n.distanceToVector3(d,d).x,P=n.coordinateToVector3(l,I);return o.getObject3d().position.copy(P),o._faceMap=g,o._baseObjects=p,o._datas=t,o._geometriesAttributes=x,o.faceIndex=null,o._geometryCache=u.clone(),o.isHide=!1,o._initBaseObjectsEvent(p),o}r(t,L);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,mt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Ut(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e],i=r[0],o=r[1];if(i<=t&&t<o)return e}},t}(Yt(l));function re(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var ie={altitude:0,height:0},oe=new R.Vector3,ae=function(p){function t(t,e,n,r){var i;e=U.Util.extend({},ie,e,{layer:r,coordinate:t}),i=p.call(this)||this;var o=e,a=o.height,s=o.altitude,h=o.color,u=[],l=[];h&&(h=h instanceof R.Color?h:new R.Color(h),l.push(h.r,h.g,h.b));var c=r.distanceToVector3(a,a).x,f=r.coordinateToVector3(t,c);u.push(f.x,f.y,f.z);var v=new R.BufferGeometry;Z(v,"position",new R.Float32BufferAttribute(u,3,!0)),l.length&&Z(v,"color",new R.Float32BufferAttribute(l,3,!0)),e.positions=f,i._initOptions(e),i._createPoints(v,n);var d=r.distanceToVector3(s,s).x;return i.getObject3d().position.z=d,i}return r(t,p),t.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(t),h=e.distanceToVector3(o,o).x;oe.x=i.x,oe.y=i.y,oe.z=i.z+h;var u=re(oe,n,r);return Math.sqrt(Math.pow(s.x-u.x,2)+Math.pow(s.y-u.y,2))<=a/2},t}(l);function se(t,e){var n=t.minx,r=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return n<=a&&a<=i&&r<=s&&s<=o}var he=function(){function f(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var t=f.prototype;return t.updateBBoxPixel=function(e){var n=1/0,r=1/0,i=-1/0,o=-1/0,t=this.minlng,a=this.minlat,s=this.maxlng,h=this.maxlat;return[[t,a],[t,h],[s,a],[s,h]].map(function(t){return new U.Coordinate(t)}).map(function(t){return e.coordToContainerPoint(t)}).forEach(function(t){n=Math.min(n,t.x),r=Math.min(r,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)}),this.minx=n,this.miny=r,this.maxx=i,this.maxy=o,this},t.containsCoordinate=function(t){var e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof U.Coordinate&&(e=t.x,n=t.y);var r=this.minlng,i=this.minlat,o=this.maxlng,a=this.maxlat;return!!(r<=e&&e<=o&&i<=n&n<=a)},t.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,h=i.maxy;return!!(se(this,[o,a])||se(this,[o,h])||se(this,[s,a])||se(this,[s,h])||se(i,[this.minx,this.miny])||se(i,[this.minx,this.maxy])||se(i,this.maxx,this.miny)||se(i,this.maxx,this.maxy))},f.initGrids=function(t,e,n,r){for(var i=[],o=(n-t)/30,a=(r-e)/30,s=t,h=e,u=0;u<30;u++){s=t+u*o;for(var l=0;l<30;l++){var c=new f(s,h=e+l*a,s+o,h+a);c.key=l+"-"+u,i.push(c)}}return i},f}(),ue={altitude:0},le=new R.Vector3,ce=function(z){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]),e=U.Util.extend({},ue,e,{layer:r,points:t});for(var o=1/0,a=1/0,s=-1/0,h=-1/0,u=0,l=t.length;u<l;u++){var c=t[u].coordinate,f=void 0,v=void 0;Array.isArray(c)?(f=c[0],v=c[1]):c instanceof U.Coordinate&&(f=c.x,v=c.y),o=Math.min(o,f),a=Math.min(a,v),s=Math.max(s,f),h=Math.max(h,v)}for(var d=he.initGrids(o,a,s,h),p=d.length,g=[],x=[],y=[],m=[],b=[],_=0,M=t.length;_<M;_++){var w=t[_],j=(c=w.coordinate,w.height),O=w.color;O&&(O=O instanceof R.Color?O:new R.Color(O),y.push(O.r,O.g,O.b));var A=r.distanceToVector3(j,j).x,C=r.coordinateToVector3(c,A);g.push(C.x,C.y,C.z),x.push(C),b[_]={position:{count:1,start:3*_,end:3*_+3},hide:!1};for(var T=0;T<p;T++)if(d[T].containsCoordinate(c)){d[T].positions.push(C),d[T].indexs.push(_);break}}var S=new R.BufferGeometry;Z(S,"position",new R.Float32BufferAttribute(g,3,!0)),y.length&&Z(S,"color",new R.Float32BufferAttribute(y,3,!0)),e.positions=x,(i=z.call(this)||this)._initOptions(e),i._createPoints(S,n);var B=e.altitude,V=r.distanceToVector3(B,B).x;return i.getObject3d().position.z=V,i._baseObjects=m,i._datas=t,i.faceIndex=null,i._geometriesAttributes=b,i._geometryCache=S.clone(),i.isHide=!1,i._initBaseObjectsEvent(m),i._grids=d,i._bindMapEvents(),i}r(t,z);var e=t.prototype;return e._bindMapEvents=function(){var t=this,e=this.getMap();this.on("add",function(){t._updateGrids(),e.on("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)}),this.on("remove",function(){e.off("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)})},e._updateGrids=function(){var e=this.getMap();this._grids.forEach(function(t){t.indexs.length&&t.updateBBoxPixel(e)})},e.getSelectMesh=function(){var t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=e.coordinate,r=e.height,i=e.color;this._baseObjects[t]=new ae(n,{height:r,index:t,color:i},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},e.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(i,i).x,s=this.getObject3d().material.size,h=o.coordToContainerPoint(t),u=[];if(this._grids.forEach(function(t){t.indexs.length&&t.isRecCross(h,s)&&u.push(t)}),u.length<1)return!1;for(var l=0,c=u.length;l<c;l++)for(var f=0,v=u[l].positions.length;f<v;f++){var d=u[l].positions[f];le.x=d.x,le.y=d.y,le.z=d.z+a;var p=re(le,n,r);if(Math.sqrt(Math.pow(h.x-p.x,2)+Math.pow(h.y-p.y,2))<=s/2)return this.faceIndex=u[l].indexs[f],!0}return!1},t}(Yt(l)),fe={coordinate:null,radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},ve=function(Z){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=t.length,a=[],s=[],h=[],u=[],l=0,c=0,f=0,v=0,d=0;d<o;d++){var p=U.Util.extend({index:d},fe,t[d]),g=p.radius,x=p.radialSegments,y=p.altitude,m=p.topColor,b=p.bottomColor,_=p.height,M=p.coordinate,w=r.distanceToVector3(g,g).x,j=r.distanceToVector3(_,_).x,O=r.distanceToVector3(y,y).x,A=G({radius:w,height:j,radialSegments:x},!1);m&&!n.map&&(W(A,b,m,"z",j/2),n.vertexColors=R.VertexColors);for(var C=r.coordinateToVector3(M),T=A.attributes.position.array,S=0,B=T.length;S<B;S+=3)T[S+2]+=O,T[S]+=C.x,T[S+1]+=C.y,T[S+2]+=C.z;a.push(A);var V=new q(M,p,n,r);s.push(V);var z=new R.Geometry;z.fromBufferGeometry(A);var k=z.faces.length;u[d]=[l+1,l+k],l+=k,z.dispose();var I=A.attributes.position.count,P=A.attributes.normal.count,L=A.attributes.uv.count;h[d]={position:{count:I,start:c,end:c+3*I},normal:{count:P,start:f,end:f+3*P},uv:{count:L,start:v,end:v+2*L},hide:!1},c+=3*I,f+=3*P,v+=2*L}i=Z.call(this)||this,e=U.Util.extend({},{altitude:0,layer:r,points:t},e),i._initOptions(e);var E=function(t){for(var e=[],n=[],r=0,i=t.length;r<i;r++){for(var o=t[r].attributes,a=o.color,s=o.normal,h=o.position,u=o.uv,l=t[r].index,c=0,f=a.array.length;c<f;c++)n.push(a.array[c]);e.push({normal:s.array,uv:u.array,position:h.array,indices:l.array})}for(var v=F(e),d=0,p=n.length;d<p;d++)v.attributes.color.array[d]=n[d];return v}(a);return i._createMesh(E,n),i._faceMap=u,i._baseObjects=s,i._datas=t,i._geometriesAttributes=h,i.faceIndex=null,i._geometryCache=E.clone(),i.isHide=!1,i._initBaseObjectsEvent(s),i}r(t,Z);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e],i=r[0],o=r[1];if(i<=t&&t<o)return e}},t}(Yt(l)),de={width:3,height:1,altitude:0},pe=function(k){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var h=t[s];o.push(yt(h)?wt(h):h.getCenter())}for(var u=Pt(o),l=[],c=[],f=0,v=[],d=[],p=0,g=0,x=0;x<a;x++){var y=t[x],m=U.Util.extend({},de,yt(y)?y.properties:y.getProperties(),{index:x}),b=m.height,_=m.width,M=Tt(y,r.distanceToVector3(_,_).x,r.distanceToVector3(b,b).x,r,u);l.push(M);var w=new zt(y,m,n,r);c.push(w);var j=M.position,O=M.normal,A=M.indices.length/3;v[x]=[f+1,f+A],f+=A;var C=j.length/3,T=O.length/3;d[x]={position:{count:C,start:p,end:p+3*C},normal:{count:T,start:g,end:g+3*T},hide:!1},p+=3*C,g+=3*T}var S=F(l);e=U.Util.extend({},de,e,{layer:r,lineStrings:t,coordinate:u}),(i=k.call(this)||this)._initOptions(e),i._createMesh(S,n);var B=e.altitude,V=r.distanceToVector3(B,B).x,z=r.coordinateToVector3(u,V);return i.getObject3d().position.copy(z),i._faceMap=v,i._baseObjects=c,i._datas=t,i._geometriesAttributes=d,i.faceIndex=null,i._geometryCache=S.clone(),i.isHide=!1,i._initBaseObjectsEvent(c),i}r(t,k);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e],i=r[0],o=r[1];if(i<=t&&t<o)return e}},t}(Yt(l)),ge={altitude:0,colors:null},xe=function(C){function t(t,e,n,r){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var h=t[s];o.push(bt(h)?wt(h):h.getCenter())}var u=Pt(o);e=U.Util.extend({},ge,e,{layer:r,lineStrings:t,coordinate:u});for(var l=[],c=0,f=[],v=[],d=0,p=[],g=0;g<a;g++){for(var x=At(t[g],r,u).positionsV,y=0,m=x.length;y<m;y++){var b=x[y];0<y&&y<m-1&&p.push(b.x,b.y,b.z),p.push(b.x,b.y,b.z)}var _=x.length+x.length-2,M=_;f[g]=[c,c+M],c+=M,v[g]={position:{count:_,start:d,end:d+3*_},hide:!1},d+=3*_}var w=new R.BufferGeometry;Z(w,"position",new R.Float32BufferAttribute(p,3)),(i=C.call(this)||this)._initOptions(e),i._createLineSegments(w,n);var j=e.altitude,O=r.distanceToVector3(j,j).x,A=r.coordinateToVector3(u,O);return i.getObject3d().position.copy(A),i._faceMap=f,i._baseObjects=l,i._datas=t,i._geometriesAttributes=v,i.faceIndex=null,i.index=null,i._geometryCache=w.clone(),i.isHide=!1,i._initBaseObjectsEvent(l),i}r(t,C);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=U.Util.extend({},this.getOptions(),{index:t},bt(e)?e.properties:e.getProperties());this._baseObjects[t]=new Bt(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex||this.index),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e],i=r[0],o=r[1];if(i<=t&&t<o)return e}},t}(Yt(l)),ye=[],me=[];function be(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.key,a=i.callback;if(e===o)return t.splice(n,1),a}}return null}var _e=document.createElement("canvas");function Me(t,e){var n=_e.getContext("2d");if(n.clearRect(0,0,256,256),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;var r=t||"tile";n.font="18px sans-serif",n.rect(0,0,256,256),n.stroke(),n.fillText(r,15,128)}return _e.toDataURL()}_e.width=_e.height=256;var we={worker:!1},je=function(o){function t(t,e,n,r){var i;return void 0===e&&(e={}),(i=o.call(this,U.Util.GUID(),U.Util.extend({urlTemplate:t},we,e))||this)._opts=e,i._layer=r,i.getMaterial=n,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i._init(),i}r(t,o);var e=t.prototype;return e.isAsynchronous=function(){return this._opts.worker},e.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},e.onSelectMesh=function(t,e){},e.formatBaseObjects=function(t,e){var n=this._opts,r=[],i=this.isAsynchronous();for(var o in e){var a=e[o]||{},s=void 0;if(Array.isArray(a)?s=a:"FeatureCollection"===a.type&&(s=a.features),s&&s.length){for(var h=[],u=[],l=[],c=0,f=s.length;c<f;c++){var v=s[c];if(mt(v))h.push(v);else if(bt(v))for(var d=jt(v),p=0,g=d.length;p<g;p++)u.push(d[p]);else if(_t(v))for(var x=jt(v),y=0,m=x.length;y<m;y++)l.push(U.Util.extend({},x[y].properties,x[y],{coordinate:Mt(x[y])}))}if(h.length){var b=this._getMaterial(o,h,t,a);if(b){var _=this._layer.toExtrudePolygons(h,U.Util.extend({},{topColor:"#fff",layerName:o,asynchronous:i,key:t},n),b);r.push(_)}}if(u.length){var M=this._getMaterial(o,u,t,a);if(M&&(M instanceof R.LineBasicMaterial||M instanceof R.LineDashedMaterial)){var w=this._layer.toLines(u,U.Util.extend({},{layerName:o},n),M);r.push(w)}}if(l.length){var j=this._getMaterial(o,l,t,a);if(j&&j instanceof R.PointsMaterial){var O=this._layer.toPoints(l,U.Util.extend({},{layerName:o},n),j);r.push(O)}}}}return r},e.loopMessage=function(t){0<{waitingQueue:ye,currentQueue:me}.currentQueue.length&&this.getTileData(t)},e.getTileData=function(t){var n=t.key,e=t.url,r=t.callback,i=t.img;U.Ajax.getJSON(e,{},function(t,e){t?(console.error(t),r(n,null,i)):r(n,e,i)})},e._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var h=o[a].dupKey;e.push(h),n[h]=!0}return{keys:e,keysMap:n}},e._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},e._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e=this._renderer.tilesInView,n=this._loadTiles,r=this._layer,i=this._baseObjectKeys,o=Object.keys(e),a=Object.keys(n).length,s=[];if(o&&a)for(var h in n)e[h]||i[h]&&(i[h]||[]).forEach(function(t){s.push(t)});if(s.length&&r.removeMesh(s,!1),o&&a)for(var u in e)if(!n[u])if(i[u]){var l=i[u];r.addMesh(l)}else{var c=u.split("_").slice(1,4),f=c[0],v=c[1],d=c[2];this.getTileUrl(v,f,d)}this._loadTiles=Object.assign({},e),this._diffCache()}},e._init=function(){var o=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){if(!1===o._add){var t=o.getBaseObjects();o._layer.addMesh(t)}o._add=!0,o.intervalId=setInterval(function(){o._isLoad()&&!o._layer.getMap().isInteracting()&&o.fire("layerload")},1e3)}),this.on("remove",function(){o._add=!1;var t=o.getBaseObjects();o._layer.removeMesh(t),clearInterval(o.intervalId)}),this.on("show",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.show()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.show()})}}),this.on("hide",function(){var t=o.getBaseObjects();for(var e in t.forEach(function(t){t.hide()}),o._baseObjectKeys){(o._baseObjectKeys[e]||[]).forEach(function(t){t.hide()})}}),this.on("renderercreate",function(t){t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.dupKey),n},t.renderer.deleteTile=function(t){if(t&&t.image){t.image.onload=null,t.image.onerror=null;var e,n,r=t.info||{};e=r.dupKey,(n=be(ye,e))&&n(e)}},t.renderer.loadTileImage=function(t,e,n){var r,i;t._key=n,i={key:n,url:e,callback:function(t,e,n){o._generateBaseObjects(t,e,n),function(t,e){if(be(me,t),ye.length){me.push(ye[0]),ye.splice(0,1);var n=me[me.length-1];e.loopMessage(n)}}(t,o)},img:t,vt:r=o},me.length<10?(me.push(i),r.loopMessage(i)):ye.push(i)}})},e._getMaterial=function(t,e,n,r){return this.getMaterial&&U.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,r):null},e._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Me(e._key,this._opts.debug))},e._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=Me(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length;for(var o=n.currentCount=0,a=i.length;o<a;o++){var s=i[o];s._img=n,(s._vt=this).isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=Me(t,this._opts.debug)),this.isAsynchronous()?i.filter(function(t){return t.isAsynchronous()}).forEach(function(t){t.on("workerload",r._workerLoad,r)}):n.src=Me(t,this._opts.debug)}else n.src=Me(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=Me(t,this._opts.debug))},e._diffCache=function(){var i=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var t=i._renderer.tileCache.data,e=i._renderer.tilesInView,n=[];for(var r in i._baseObjectKeys)t[r]||e[r]||((i._baseObjectKeys[r]||[]).forEach(function(t){t.isAdd&&n.push(t)}),i._diposeBaseObject(r),delete i._baseObjectKeys[r]);n.length&&i._layer.removeMesh(n,!1)}()},e._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t=null})},e._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},t}(U.TileLayer),Oe=Math.PI/180,Ae=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Ce=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Te=new R.Matrix4,Se=function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var n=e.prototype;return n.draw=function(){this.renderScene()},n.drawOnInteracting=function(){this.renderScene()},n.coordinateToVector3=function(t,e){void 0===e&&(e=0);var n=this.getMap();if(!n)return null;t instanceof U.Coordinate||(t=new U.Coordinate(t));var r=n.coordinateToPoint(t,Ve(n));return new R.Vector3(r.x,r.y,e)},n.distanceToVector3=function(t,e,n){var r=this.getMap(),i=Ve(r),o=n||r.getCenter();o instanceof U.Coordinate||(o=new U.Coordinate(o));var a=r.locate(o,t,e),s=r.coordinateToPoint(o,i),h=r.coordinateToPoint(a,i),u=Math.abs(h.x-s.x)*U.Util.sign(t),l=Math.abs(h.y-s.y)*U.Util.sign(e);return new R.Vector3(u,l,0)},n.toShape=function(t){var n=this;if(!t)return null;if(t instanceof U.MultiPolygon)return t.getGeometries().map(function(t){return n.toShape(t)});var e=t.getCenter(),r=this.coordinateToVector3(e),i=t.getShell().map(function(t){return n.coordinateToVector3(t).sub(r)}),o=new R.Shape(i),a=t.getHoles();return a&&0<a.length&&(o.holes=a.map(function(t){var e=t.map(function(t){return n.coordinateToVector3(t).sub(r)});return new R.Shape(e)})),o},n.toExtrudeMesh=function(t,e,n,r){var i=this;if(!t)return null;if(t instanceof U.MultiPolygon)return t.getGeometries().map(function(t){return i.toExtrudeMesh(t,e,n,r)});var o=t.getCoordinates();o.forEach(function(t){for(var e=t.length-1;1<=e;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(o);var a=this.toShape(t),s=this.coordinateToVector3(t.getCenter());r=U.Util.isNumber(r)?r:e,r=this.distanceToVector3(r,r).x;var h=this.distanceToVector3(e,e).x,u={bevelEnabled:!1,bevelSize:1};u[93<=parseInt(R.REVISION)?"depth":"amount"]=r;var l=new R.ExtrudeGeometry(a,u),c=new R.BufferGeometry;c.fromGeometry(l);var f=new R.Mesh(c,n);return f.position.set(s.x,s.y,h-r),f},n.toExtrudePolygon=function(t,e,n){return new Ut(t,e,n,this)},n.toBar=function(t,e,n){return new q(t,e,n,this)},n.toLine=function(t,e,n){return new Bt(t,e,n,this)},n.toExtrudeLine=function(t,e,n){return new zt(t,e,n,this)},n.toModel=function(t,e){return new Ft(t,e,this)},n.toExtrudeLineTrail=function(t,e,n){return new Xt(t,e,n,this)},n.toExtrudePolygons=function(t,e,n){return new ne(t,e,n,this)},n.toPoint=function(t,e,n){return new ae(t,e,n,this)},n.toPoints=function(t,e,n){return new ce(t,e,n,this)},n.toBars=function(t,e,n){return new ve(t,e,n,this)},n.toExtrudeLines=function(t,e,n){return new pe(t,e,n,this)},n.toLines=function(t,e,n){return new xe(t,e,n,this)},n.toThreeVectorTileLayer=function(t,e,n){return new je(t,e,n,this)},n.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;0<=e;e--)t.children[e]instanceof R.Mesh&&t.remove(t.children[e]);return this},n.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},n.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},n.getScene=function(){var t=this._getRenderer();return t?t.scene:null},n.renderScene=function(){var t=this._getRenderer();return t?t.renderScene():this},n.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},n.addMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof l?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&U.Util.isFunction(t._animation)&&(n._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof R.Object3D&&r.add(t)}),this._zoomend(),e&&this.renderScene(),this},n.removeMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof l?(r.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&U.Util.isFunction(t._animation)&&delete n._animationBaseObjectMap[t.getObject3d().uuid]):t instanceof R.Object3D&&r.remove(t)}),e&&this.renderScene(),this},n._initRaycaster=function(){return this._raycaster||(this._raycaster=new R.Raycaster,this._mouse=new R.Vector2),this},n.identify=function(e,t){var r=this;if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(e)&&(e=new U.Coordinate(e)),!(e instanceof U.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var n=this.getMap().coordToContainerPoint(e),i=n.x,o=n.y;this._initRaycaster();var a=this._raycaster,s=this._mouse,h=this.getCamera(),u=this.getScene(),l=this.getMap().getSize();if(!u)return[];var c=l.width,f=l.height;s.x=i/c*2-1,s.y=-o/f*2+1,a.setFromCamera(s,h),a.linePrecision=this._getLinePrecision(this.getMap().getResolution());var v=[],d=[];u.children.forEach(function(t){var e=t.__parent;e&&e.getOptions?e.getOptions().interactive&&e.isVisible()&&(e.identify&&U.Util.isFunction(e.identify)?d.push(e):v.push(t)):(t instanceof R.Mesh||t instanceof R.Group)&&v.push(t)});var p=[],g=a.intersectObjects(v,!0);g&&Array.isArray(g)&&g.length&&(p=g.map(function(t){var e=t.object,n=(e=r._recursionMesh(e)).__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n})),d.length&&d.forEach(function(t){t.identify(e)&&p.push(t)});var x=(t=U.Util.extend({},t)).count;return U.Util.isNumber(x)&&0<x?p.slice(0,x):p},n._recursionMesh=function(t){for(;t&&!(t.parent instanceof R.Scene);)t=t.parent;return t||{}},n._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=Ae.length;e<n;e++){var r=Ae[e],i=r[0],o=r[1];if(i<t)return o}return.01},n._identifyBaseObjectEvents=function(n){var t=this.map||this.getMap();t.resetCursor("default");var r=n.type,i=n.coordinate,o=this.identify(i),e=this.getScene();if(0===o.length&&e)for(var a=0,s=e.children.length;a<s;a++){var h=(e.children[a]||{}).__parent;h&&h.fire("empty",Object.assign({},n,{target:h}))}if("mousemove"===r){o.length&&t.setCursor("pointer");var u=[];this._baseObjects&&this._baseObjects.forEach(function(e){var n=!0;o.forEach(function(t){e===t&&(n=!1)}),n&&u.push(e)}),u.forEach(function(t){t instanceof l&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},n,{target:t,type:"mouseout"})),t.closeToolTip()))}),o.forEach(function(t){if(t instanceof l){t._mouseover||(t.fire("mouseover",Object.assign({},n,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0),t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));var e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(i)}})}else o.forEach(function(t){if(t instanceof l&&(t.fire(r,Object.assign({},n,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),"click"===r)){var e=t.getInfoWindow();e&&!e._owner&&e.addTo(t),t.openInfoWindow(i)}});return this._baseObjects=o,this},n._zoomend=function(){var t=this.getScene();if(t){var i=this.getMap().getZoom();t.children.forEach(function(t){var e=t.__parent;if(e&&e.getOptions){var n=e.getMinZoom(),r=e.getMaxZoom();(i<n||r<i)&&e.isVisible()?e.hide():n<=i&&i<=r&&!e.isVisible()&&e.show()}})}},n.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var n=this.map||this.getMap();return n&&(Ce.forEach(function(t){n.on(t,e._identifyBaseObjectEvents,e)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this)),this},n.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var n=this.map||this.getMap();return n&&(Ce.forEach(function(t){n.off(t,e._identifyBaseObjectEvents,e)}),n.off("zooming zoomend",this._zoomend,this)),this},n._callbackBaseObjectAnimation=function(){if(this._animationBaseObjectMap)for(var t in this._animationBaseObjectMap){this._animationBaseObjectMap[t]._animation()}return this},n._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*Oe)},e}(U.CanvasLayer);Se.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null});var Be=function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[this.scene,this.camera]},n.getDrawParams=function(){return[this.scene,this.camera]},n._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments)},n.hitDetect=function(){return!1},n.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},n.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},n._initThreeRenderer=function(){var t=new R.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new R.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),t.canvas=this.canvas,this.context=t;var e=this.scene=new R.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,i=this.camera=new R.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),e.add(i)},n.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},n.resizeCanvas=function(t){if(this.canvas){var e;e=t||this.getMap().getSize();var n=U.Browser.retina?2:1,r=this.canvas;r.height=n*e.height,r.width=n*e.width,this.context.setSize(r.width,r.height)}},n.clearCanvas=function(){this.canvas&&this.context.clear()},n.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.renderScene=function(){this.layer._callbackBaseObjectAnimation(),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},n._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,e.projectionMatrixInverse.elements=Te.getInverse(e.projectionMatrix).elements},n._createGLContext=function(t,e){for(var n=["webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r},e}(U.renderer.CanvasLayerRenderer);function Ve(t){return t.getGLZoom()}Se.registerRenderer("gl",Be),t.ThreeLayer=Se,t.ThreeRenderer=Be,t.BaseObject=l,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.7.1, requires maptalks@>=0.39.0.")});
