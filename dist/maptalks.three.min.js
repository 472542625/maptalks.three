/*!
 * maptalks.three v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.THREE)}(this,function(e,t,r){"use strict";function n(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],a=Object.getOwnPropertyDescriptor(t,o);a&&a.configurable&&void 0===e[o]&&Object.defineProperty(e,o,a)}return e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):n(e,t))}r="default"in r?r.default:r;var s={renderer:"webgl",doubleBuffer:!0,glOptions:null},c=Math.PI/180,h=function(e){function n(){return o(this,n),a(this,e.apply(this,arguments))}return i(n,e),n.prototype.draw=function(){this.renderScene()},n.prototype.drawOnInteracting=function(){this.renderScene()},n.prototype.coordinateToVector3=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getMap();if(!n)return null;var o=n.coordinateToPoint(e,n.getMaxNativeZoom());return new r.Vector3(o.x,o.y,t)},n.prototype.distanceToVector3=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=this.getMap(),a=o.getScale(),i=this._getFovRatio(),s=o.distanceToPixel(e,t)._multi(a/i);return new r.Vector3(s.width,s.height,n)},n.prototype.toShape=function(e){var n=this;if(!e)return null;if(e instanceof t.MultiPolygon)return e.getGeometries().map(function(e){return n.toShape(e)});var o=e.getCenter(),a=this.coordinateToVector3(o),i=e.getShell(),s=i.map(function(e){return n.coordinateToVector3(e).sub(a)}),c=new r.Shape(s),h=e.getHoles();return h&&h.length>0&&(c.holes=h.map(function(e){var t=e.map(function(e){return n.coordinateToVector3(e).sub(a)});return new r.Shape(t)})),c},n.prototype.toExtrudeGeometry=function(e,n,o,a){var i=this;if(!e)return null;if(e instanceof t.MultiPolygon)return e.getGeometries().map(function(e){return i.toExtrudeGeometry(e,n,o)});if(a){var s=e.getCoordinates();s.forEach(function(e){for(var t=e.length,r=t-1;r>=1;r--)e[r].equals(e[r-1])&&e.splice(r,1)}),e.setCoordinates(s)}var c=this.toShape(e),h=this.coordinateToVector3(e.getCenter());n=this.distanceToVector3(n,n).x;var p=new r.ExtrudeGeometry(c,{amount:n,bevelEnabled:!0}),u=new r.BufferGeometry;u.fromGeometry(p);var l=new r.Mesh(u,o);return l.position.set(h.x,h.y,-n),l},n.prototype.clearMesh=function(){var e=this.getScene();if(!e)return this;for(var t=e.children.length-1;t>=0;t--)e.children[t]instanceof r.Mesh&&e.remove(e.children[t]);return this},n.prototype.lookAt=function(e){var t=this._getRenderer();return t&&t.context.lookAt(e),this},n.prototype.getCamera=function(){var e=this._getRenderer();return e?e.camera:null},n.prototype.getScene=function(){var e=this._getRenderer();return e?e.scene:null},n.prototype.renderScene=function(){var e=this._getRenderer();return e?e.renderScene():this},n.prototype.getThreeRenderer=function(){var e=this._getRenderer();return e?e.context:null},n.prototype._getFovRatio=function(){var e=this.getMap(),t=e.getFov();return Math.tan(t/2*c)},n}(t.CanvasLayer);h.mergeOptions(s);var p=function(e){function n(){return o(this,n),a(this,e.apply(this,arguments))}return i(n,e),n.prototype.getPrepareParams=function(){return[this.scene,this.camera]},n.prototype.getDrawParams=function(){return[this.scene,this.camera]},n.prototype._drawLayer=function(){e.prototype._drawLayer.apply(this,arguments),this.renderScene()},n.prototype.hitDetect=function(){return!1},n.prototype.createCanvas=function(){if(!this.canvas){var e=this.getMap(),n=e.getSize(),o=t.Browser.retina?2:1;this.canvas=t.Canvas.createCanvas(o*n.width,o*n.height);var a,i=this.layer.options.renderer;"webgl"===i?(a=new r.WebGLRenderer(t.Util.extend({canvas:this.canvas,alpha:!0,preserveDrawingBuffer:!0},this.layer.options.glOptions)),a.autoClear=!1,a.clear()):"canvas"===i&&(a=new r.CanvasRenderer(t.Util.extend({canvas:this.canvas,alpha:!0},this.layer.options.glOptions))),a.setSize(this.canvas.width,this.canvas.height),a.setClearColor(new r.Color(1,1,1),0),a.canvas=this.canvas,this.context=a;var s=e.getScale(e.getMinZoom())/e.getScale(e.getMaxNativeZoom()),c=s*n.height/2/this.layer._getFovRatio(),h=this.scene=new r.Scene,p=e.getFov(),u=this.camera=new r.PerspectiveCamera(p,n.width/n.height,1,c);this.onCanvasCreate(),this.layer.onCanvasCreate(this.context,this.scene,this.camera),h.add(u)}},n.prototype.resizeCanvas=function(e){if(this.canvas){var r;r=e?e:this.getMap().getSize();var n=t.Browser.retina?2:1;this.canvas.height=n*r.height,this.canvas.width=n*r.width,this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix(),this.context.setSize(this.canvas.width,this.canvas.height)}},n.prototype.clearCanvas=function(){this.canvas&&this.context.clear()},n.prototype.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.prototype.renderScene=function(){this._locateCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.prototype.remove=function(){delete this._drawContext,e.prototype.remove.call(this)},n.prototype._locateCamera=function(){var e=this.getMap(),t=e.getSize(),n=e.getScale(),o=this.camera,a=e.coordinateToPoint(e.getCenter(),e.getMaxNativeZoom()),i=e.getPitch()*c,s=e.getBearing()*c,h=this.layer._getFovRatio(),p=-n*t.height/2/h;o.position.z=p*Math.cos(i);var u=Math.sin(i)*p;o.position.x=a.x+u*Math.sin(s),o.position.y=a.y-u*Math.cos(s),o.up.set(Math.sin(s),-Math.cos(s),0),o.lookAt(new r.Vector3(a.x,a.y,0)),o.updateProjectionMatrix()},n}(t.renderer.CanvasLayerRenderer);h.registerRenderer("canvas",p),h.registerRenderer("webgl",p),e.ThreeLayer=h,e.ThreeRenderer=p,Object.defineProperty(e,"__esModule",{value:!0})});