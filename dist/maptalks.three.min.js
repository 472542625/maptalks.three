/*!
 * maptalks.three v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.THREE)}(this,function(e,t,r){"use strict";function n(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],a=Object.getOwnPropertyDescriptor(t,o);a&&a.configurable&&void 0===e[o]&&Object.defineProperty(e,o,a)}return e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):n(e,t))}r="default"in r?r.default:r;var s={renderWhenPanning:!0,camera:"perspective",renderer:"webgl",doubleBuffer:!0,glOptions:null},c=function(e){function n(){return o(this,n),a(this,e.apply(this,arguments))}return i(n,e),n.prototype.coordinateToVector3=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getMap();if(!n)return null;var o=n.coordinateToPoint(e,n.getMaxZoom());return new r.Vector3(o.x,o.y,t)},n.prototype.redraw=function(){e.prototype.redraw.call(this)},n.prototype.distanceToVector3=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=this.getMap(),a=o.getScale(),i=o.distanceToPixel(e,t)._multi(a);return new r.Vector3(i.width,i.height,n)},n.prototype.toShape=function(e){var n=this;if(!e)return null;if(e instanceof t.MultiPolygon)return e.getGeometries().map(function(e){return n.toShape(e)});var o=e.getCenter(),a=this.coordinateToVector3(o),i=e.getShell(),s=i.map(function(e){return n.coordinateToVector3(e).sub(a)}),c=new r.Shape(s),h=e.getHoles();return h&&h.length>0&&(c.holes=h.map(function(e){var t=e.map(function(e){return n.coordinateToVector3(e).sub(a)});return new r.Shape(t)})),c},n.prototype.toExtrudeGeometry=function(e,n,o){var a=this;if(!e)return null;if(e instanceof t.MultiPolygon)return e.getGeometries().map(function(e){return a.toExtrudeGeometry(e,n,o)});var i=this.toShape(e),s=this.coordinateToVector3(e.getCenter());n=this.distanceToVector3(n,n).x;var c=new r.ExtrudeGeometry(i,{amount:n,bevelEnabled:!0}),h=new r.Mesh(c,o);return h.position.set(s.x,s.y,-n),h},n.prototype.lookAt=function(e){var t=this._getRenderer();return t&&t.context.lookAt(e),this},n.prototype.getCamera=function(){var e=this._getRenderer();return e?e.camera:null},n.prototype.getScene=function(){var e=this._getRenderer();return e?e.scene:null},n.prototype.renderScene=function(){var e=this._getRenderer();return e?e.renderScene():this},n.prototype.getThreeRenderer=function(){var e=this._getRenderer();return e?e.context:null},n}(t.CanvasLayer);c.mergeOptions(s);var h=function(e){function n(){return o(this,n),a(this,e.apply(this,arguments))}return i(n,e),n.prototype.hitDetect=function(){return!1},n.prototype.createCanvas=function(){if(!this.canvas){var e=this.getMap(),n=e.getSize(),o=t.Browser.retina?2:1;this.canvas=t.Canvas.createCanvas(o*n.width,o*n.height);var a,i=this.layer.options.renderer;"webgl"===i?(a=new r.WebGLRenderer(t.Util.extend({canvas:this.canvas,alpha:!0,preserveDrawingBuffer:!0},this.layer.options.glOptions)),a.autoClear=!1,a.clear()):"canvas"===i&&(a=new r.CanvasRenderer(t.Util.extend({canvas:this.canvas,alpha:!0},this.layer.options.glOptions))),a.setSize(this.canvas.width,this.canvas.height),a.setClearColor(new r.Color(1,1,1),0),a.canvas=this.canvas,this.context=a;var s=e.getScale(e.getMinZoom())/e.getScale(e.getMaxZoom()),c=this.scene=new r.Scene,h=this.camera=new r.PerspectiveCamera(90,n.width/n.height,1,1e4*s);this.onCanvasCreate(),this.layer.onCanvasCreate(this.context,this.scene,this.camera),c.add(h)}},n.prototype.resizeCanvas=function(e){if(this.canvas){var r;r=e?e:this.getMap().getSize();var n=t.Browser.retina?2:1;this.canvas.height=n*r.height,this.canvas.width=n*r.width,this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix(),this.context.setSize(this.canvas.width,this.canvas.height)}},n.prototype.clearCanvas=function(){this.canvas&&this.context.clear()},n.prototype.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.prototype.draw=function(){this.prepareCanvas(),this._predrawed||(this._drawContext=this.layer.prepareToDraw(this.context,this.scene,this.camera),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0),this._drawLayer()},n.prototype._drawLayer=function(){var e=[this.context,this.scene,this.camera];e.push.apply(e,this._drawContext),this.layer.draw.apply(this.layer,e),this.renderScene(),this.play()},n.prototype.renderScene=function(){this._locateCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.prototype.remove=function(){delete this._drawContext,e.prototype.remove.call(this)},n.prototype.onZoomStart=function(t){this.layer.onZoomStart(this.scene,this.camera,t),e.prototype.onZoomStart.call(this,t)},n.prototype.onZoomEnd=function(t){this.layer.onZoomEnd(this.scene,this.camera,t),e.prototype.onZoomEnd.call(this,t)},n.prototype.onMoveStart=function(t){this.layer.onMoveStart(this.scene,this.camera,t),e.prototype.onMoveStart.call(this,t)},n.prototype.onMoving=function(e){this.layer.options.renderWhenPanning&&(this.prepareRender(),this.draw())},n.prototype.onMoveEnd=function(t){this.layer.onMoveEnd(this.scene,this.camera,t),e.prototype.onMoveEnd.call(this,t)},n.prototype.onResize=function(t){this.layer.onResize(this.scene,this.camera,t),e.prototype.onResize.call(this,t)},n.prototype._locateCamera=function(){var e=this.getMap(),t=e.getFullExtent(),n=e.getSize(),o=e.getScale(),a=this.camera,i=e.getCenter(),s=e.coordinateToPoint(i,e.getMaxZoom()),c=o*n.height/2;a.position.set(s.x,s.y,-c),a.up.set(0,t.top>=t.bottom?-1:1,0),a.lookAt(new r.Vector3(s.x,s.y,0)),this.camera.updateProjectionMatrix()},n}(t.renderer.CanvasLayerRenderer);c.registerRenderer("canvas",h),c.registerRenderer("webgl",h),e.ThreeLayer=c,e.ThreeRenderer=h,Object.defineProperty(e,"__esModule",{value:!0})});